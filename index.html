<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Estonia • Temperatura powietrza 2 m</title>
    <style>
        body { margin: 0; padding: 0; font-family: Arial, sans-serif; background: #fff; }
        #container { position: relative; width: 100vw; height: 100vh; }
        #background { position: absolute; top: 0; left: 0; width: 100%; height: 100%; background: #f0f0f0; }
        canvas { position: absolute; top: 0; left: 0; width: 100%; height: 100%; }
        #title { position: absolute; top: 10px; left: 20px; font-size: 24px; font-weight: bold; color: #000; z-index: 10; }
        #timestamp { position: absolute; top: 50px; left: 20px; font-size: 16px; color: #000; z-index: 10; }
        #source { position: absolute; bottom: 10px; left: 20px; font-size: 12px; color: #000; z-index: 10; }
        #source a { color: #000; }
        .legend { position: absolute; top: 50%; right: 20px; transform: translateY(-50%); background: rgba(255,255,255,0.8); padding: 10px; border: 1px solid #ccc; z-index: 10; }
        .legend canvas { margin-bottom: 10px; }
        .legend div { text-align: center; font-size: 14px; }
    </style>
</head>
<body>
    <div id="container">
        <div id="background"></div>
        <canvas id="heatmap"></canvas>
        <canvas id="labels"></canvas>
        <div id="title">Estonia • Temperatura powietrza 2 m</div>
        <div id="timestamp">Loading data...</div>
        <div id="source">Źródło: Estonian Environment Agency • <a href="https://ilmateenistus.ee" target="_blank">ilmateenistus.ee</a></div>

        <div class="legend">
            <canvas id="legendCanvas" width="40" height="600"></canvas>
            <div>-40 °C</div>
            <div style="margin-top: 260px;">0 °C</div>
            <div style="margin-top: 240px;">50 °C</div>
        </div>
    </div>

    <script src="https://cdnjs.cloudflare.com/ajax/libs/simpleheat/0.4.0/simpleheat.min.js"></script>
    <script>
        const proxyUrl = 'https://api.allorigins.win/raw?url=';
        const dataUrl = 'https://ilmateenistus.ee/ilma_andmed/xml/observations.php';

        // Custom color stops exactly from your QGIS ramp (value => #rrggbb)
        const colorStops = [
            {-40, '#ff6eff'}, {-38, '#ff46f8'}, {-36, '#f627eb'}, {-35, '#e522de'}, {-33, '#d41dd1'},
            {-30, '#c318c4'}, {-29, '#b414b9'}, {-28, '#a510ae'}, {-27, '#960ca3'}, {-26, '#870898'},
            {-25, '#78048d'}, {-24, '#64007f'}, {-23, '#57007f'}, {-22, '#4b007f'}, {-21, '#3e007f'},
            {-20, '#32007f'}, {-19, '#00287f'}, {-18, '#00327f'}, {-17, '#003c7f'}, {-16, '#00467f'},
            {-15, '#00528f'}, {-14, '#0062af'}, {-13, '#0072cf'}, {-12, '#0082ef'}, {-11, '#1392ff'},
            {-10, '#259aff'}, {-9, '#49acff'}, {-8, '#5bb4ff'}, {-7, '#6dbcff'}, {-6, '#7fc4ff'},
            {-5, '#91ccff'}, {-4, '#9ad0ff'}, {-3, '#a3d4ff'}, {-2, '#b5dcff'}, {-1, '#c7e4ff'},
            {0, '#d9ecff'}, {1, '#b1f1d6'}, {2, '#95dfbc'}, {3, '#87d3ab'}, {4, '#62af88'},
            {5, '#4a9775'}, {6, '#07a127'}, {7, '#08b30f'}, {8, '#21bb0e'}, {9, '#39c20c'},
            {10, '#52ca0b'}, {11, '#84d908'}, {12, '#9ce106'}, {13, '#b5e805'}, {14, '#cef003'},
            {15, '#e6f702'}, {16, '#f3fb01'}, {17, '#ebe816'}, {18, '#f4d90b'}, {19, '#f4cb0b'},
            {20, '#f4bd0b'}, {21, '#f4a20b'}, {22, '#f4880b'}, {23, '#f47a0b'}, {24, '#f46d0b'},
            {25, '#f4520b'}, {26, '#e83709'}, {27, '#dc2708'}, {28, '#c41a0a'}, {29, '#ba130f'},
            {30, '#af0f14'}, {31, '#8c0000'}, {32, '#780000'}, {33, '#640000'}, {34, '#8c3232'},
            {35, '#b46464'}, {36, '#c87878'}, {37, '#f0a0a0'}, {38, '#ffb4b4'}, {39, '#ffc8c8'},
            {40, '#ffdcdc'}, {42, '#fff0f0'}, {44, '#e2e2e2'}, {45, '#c5c5c5'}, {47, '#a8a8a8'},
            {49, '#8a8a8a'}, {50, '#6d6d6d'}
        ];

        function getColor(temp) {
            if (temp <= -40) return colorStops[0][1];
            if (temp >= 50) return colorStops[colorStops.length-1][1];

            for (let i = 0; i < colorStops.length - 1; i++) {
                const low = colorStops[i];
                const high = colorStops[i+1];
                if (temp >= low[0] && temp < high[0]) {
                    const ratio = (temp - low[0]) / (high[0] - low[0]);
                    return interpolateColor(low[1], high[1], ratio);
                }
            }
            return '#6d6d6d';
        }

        function interpolateColor(c1, c2, ratio) {
            const r1 = parseInt(c1.slice(1,3),16), g1 = parseInt(c1.slice(3,5),16), b1 = parseInt(c1.slice(5,7),16);
            const r2 = parseInt(c2.slice(1,3),16), g2 = parseInt(c2.slice(3,5),16), b2 = parseInt(c2.slice(5,7),16);
            const r = Math.round(r1 + ratio * (r2 - r1));
            const g = Math.round(g1 + ratio * (g2 - g1));
            const b = Math.round(b1 + ratio * (b2 - b1));
            return `rgb(${r},${g},${b})`;
        }

        // Draw legend
        function drawLegend() {
            const canvas = document.getElementById('legendCanvas');
            const ctx = canvas.getContext('2d');
            const height = canvas.height;
            for (let y = 0; y < height; y++) {
                const temp = -40 + (y / height) * 90; // -40 to +50
                ctx.fillStyle = getColor(temp);
                ctx.fillRect(0, height - y - 1, 40, 1);
            }
        }
        drawLegend();

        // Simpleheat instance
        const heatmapCanvas = document.getElementById('heatmap');
        const heat = simpleheat('heatmap');
        heat.radius(60, 40); // larger radius for smoother fill like in your image

        const labelsCanvas = document.getElementById('labels');
        const lctx = labelsCanvas.getContext('2d');

        // Estonia bounds for projection
        const minLat = 57.5, maxLat = 59.7;
        const minLon = 21.5, maxLon = 28.2;

        function project(lat, lon) {
            const x = (lon - minLon) / (maxLon - minLon) * heatmapCanvas.width;
            const y = (1 - (lat - minLat) / (maxLat - minLat)) * heatmapCanvas.height;
            return [x, y];
        }

        // Resize canvases
        function resize() {
            const rect = document.getElementById('container').getBoundingClientRect();
            heatmapCanvas.width = labelsCanvas.width = rect.width;
            heatmapCanvas.height = labelsCanvas.height = rect.height;
            heat._renderer.canvas.width = rect.width;
            heat._renderer.canvas.height = rect.height;
            drawLegend();
        }
        window.addEventListener('resize', resize);
        resize();

        fetch(proxyUrl + encodeURIComponent(dataUrl))
            .then(r => r.text())
            .then(xmlText => {
                const parser = new DOMParser();
                const xml = parser.parseFromString(xmlText, "text/xml");
                const obs = xml.querySelector('observations');
                const ts = parseInt(obs.getAttribute('timestamp')) * 1000;
                const date = new Date(ts);
                document.getElementById('timestamp').textContent = 
                    date.toUTCString().replace('GMT', 'UTC');

                const stations = xml.querySelectorAll('station');
                const points = [];
                const labelData = [];

                stations.forEach(st => {
                    const name = st.querySelector('name')?.textContent;
                    const lat = parseFloat(st.querySelector('latitude')?.textContent);
                    const lon = parseFloat(st.querySelector('longitude')?.textContent);
                    const tempStr = st.querySelector('airtemperature')?.textContent;
                    const temp = tempStr ? parseFloat(tempStr) : NaN;

                    if (!isNaN(lat) && !isNaN(lon) && !isNaN(temp)) {
                        const [x, y] = project(lat, lon);

                        // Intensity 0-1 based on -40..50 range
                        const intensity = Math.max(0, Math.min(1, (temp + 40) / 90));

                        points.push([x, y, intensity]);
                        labelData.push({x, y, temp: temp.toFixed(1)});
                    }
                });

                heat.data(points);
                heat.gradient({0.0: getColor(-40), 1.0: getColor(50)}); // use exact ramp ends
                heat.draw();

                // Draw temperature labels
                lctx.font = 'bold 14px Arial';
                lctx.textAlign = 'center';
                lctx.textBaseline = 'middle';
                lctx.fillStyle = '#000';
                lctx.strokeStyle = '#fff';
                lctx.lineWidth = 3;

                labelData.forEach(ld => {
                    lctx.strokeText(ld.temp, ld.x, ld.y);
                    lctx.fillText(ld.temp, ld.x, ld.y);
                });
            })
            .catch(err => {
                document.getElementById('timestamp').textContent = 'Error loading data';
                console.error(err);
            });
    </script>
</body>
</html>
